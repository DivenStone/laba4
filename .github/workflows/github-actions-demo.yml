name: CI для лабы 4

on:
  push:
    branches: [ main, master ]
  pull_request:
    branches: [ main, master ]

jobs:
  test:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout репозитория
        uses: actions/checkout@v4
      - name: Установка Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.10'

      - name: Установка зависимостей
        run: |
          pip install --upgrade pip
          pip install -r updating.txt

      - name: Задание 0 - генерация .bin
        run: |
          python PythonProject3/1.py tests/primer1.yaml task.bin
          test -f task.bin && echo "task.bin создан"

      # ---------- 2. ДЗ №1: бинарный → JSON (самописный) ----------
      - name: ДЗ №1 – конвертация в JSON (ручной парсер)
        run: |
          python src/dop1.py task.bin output_manual.json
          diff -u tests/expected.json output_manual.json || (echo "JSON не совпадает с эталоном" && exit 1)

      # ---------- 3. ДЗ №2: бинарный → JSON (библиотеки) ----------
      - name: ДЗ №2 – конвертация в JSON (Yamlium + json)
        run: |
          python src/dop2.py task.bin output_lib.json
          diff -u tests/expected.json output_lib.json || (echo "JSON (библ) не совпадает" && exit 1)

      # ---------- 4. ДЗ №3: бинарный → XML ----------
      - name: ДЗ №3 – конвертация в XML
        run: |
          python src/dop3.py task.bin output.xml
          diff -u tests/expected.xml output.xml || (echo "XML не совпадает" && exit 1)

      # ---------- 5. ДЗ №4: сравнение производительности ----------
      - name: ДЗ №4 – замер производительности (100 итераций)
        run: |
          python src/dop4.py

      # ---------- 6. Сохранение артефактов (обновлено до v4) ----------
      - name: Загрузка артефактов
        # Обновлено до v4 [citation:8][citation:10]
        uses: actions/upload-artifact@v4
        with:
          name: results
          path: |
            output_manual.json
            output_lib.json
            output.xml
            task.bin
