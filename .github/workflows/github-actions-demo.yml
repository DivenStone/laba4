name: CI для лабораторной работы

on:
  push:
    branches: [ main, master ]
  pull_request:
    branches: [ main, master ]

jobs:
  test:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout репозитория
        uses: actions/checkout@v3

      - name: Установка Python 3.10
        uses: actions/setup-python@v4
        with:
          python-version: '3.10'

      - name: Установка зависимостей
        run: |
          pip install --upgrade pip
          pip install -r requirements.txt

      - name: Задание 0 – генерация .bin
        run: |
          python src/mandatory.py tests/schedule.yaml task.bin
          # Проверяем, что файл создался
          test -f task.bin && echo "task.bin создан"

      - name: ДЗ №1 – конвертация в JSON (ручной парсер)
        run: |
          python src/dop1.py task.bin output_manual.json
          # Сравниваем с эталоном
          diff -u tests/expected.json output_manual.json || (echo "JSON не совпадает с эталоном" && exit 1)
      - name: ДЗ №2 – конвертация в JSON (Yamlium + orjson/json)
        run: |
          python src/dop2.py task.bin output_lib.json
          diff -u tests/expected.json output_lib.json || (echo "JSON (библ) не совпадает" && exit 1)

      - name: ДЗ №3 – конвертация в XML
        run: |
          python src/dop3.py task.bin output.xml
          diff -u tests/expected.xml output.xml || (echo "XML не совпадает" && exit 1)

      - name: ДЗ №4 – замер производительности (100 итераций)
        run: |
          python src/dop4.py   # скрипт сам выводит результат, проверяем exit code

      
      - name: Проверка стиля кода (flake8)
        run: |
          pip install flake8
          flake8 src/ --max-line-length=120
        continue-on-error: true  

      - name: Загрузка артефактов
        uses: actions/upload-artifact@v3
        with:
          name: results
          path: |
            output_manual.json
            output_lib.json
            output.xml
            task.bin
